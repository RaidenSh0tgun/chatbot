<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SPAA Friday Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        /* --- 1. BASE STYLES FROM NEW DESIGN --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: system-ui, -apple-system, sans-serif; background-color: #ffffff; }

        .webchat-container {
            display: flex; flex-direction: column; height: 100vh;
            border: none; overflow: hidden; background-color: #f5f5f5;
        }

        .webchat-main { display: flex; flex-direction: column; flex: 1; background-color: #ffffff; }

        /* Rutgers Scarlet Header */
        .webchat-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background: #ce0e2d; color: white;
        }
        .header-title h1 { font-size: 16px; font-weight: 600; }

        /* Messages Area */
        .webchat-messages { flex: 1; overflow-y: auto; padding: 15px; background-color: #f4f6fb; }
        .message-list { display: flex; flex-direction: column; gap: 12px; }

        /* Message Bubbles */
        .message { display: flex; align-items: flex-start; gap: 8px; font-size: 14px; line-height: 1.4; }
        .bot-msg { justify-content: flex-start; }
        .user-msg { justify-content: flex-end; }

        .ai-avatar { border-radius: 50%; background: #eee; }
        .message-content { max-width: 80%; }
        
        .message-bubble { 
            padding: 10px 14px; border-radius: 15px; 
            border: 1px solid #e1e4f0; position: relative;
        }

        .bot-msg .message-bubble { background-color: white; color: #111827; border-bottom-left-radius: 2px; }
        .user-msg .message-bubble { background-color: #ce0e2d; color: white; border-bottom-right-radius: 2px; border: none; }

        /* Links/Citations inside Bot bubbles */
        .source-link { color: #007bff; text-decoration: none; font-weight: bold; margin-left: 4px; }
        .source-link:hover { text-decoration: underline; }

        /* Input Area */
        .webchat-input { padding: 10px; border-top: 1px solid #e5e7eb; background: white; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        
        .message-input { 
            width: 100%; resize: none; border-radius: 20px; border: 1px solid #d1d5db;
            padding: 10px 50px 10px 15px; font-size: 14px; outline: none; height: 42px;
        }

        .send-button-inline {
            position: absolute; right: 5px; width: 34px; height: 34px;
            border-radius: 50%; border: none; background: #ce0e2d; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .send-button-inline:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Footer */
        .webchat-footer { padding: 6px 12px; font-size: 11px; background: #f9fafb; border-top: 1px solid #e5e7eb; color: #6b7280; text-align: center; }
        
        /* Thinking state */
        .thinking { font-style: italic; color: #888; }

        /* Align user timestamp to the right, bot to the left */
        .message-timestamp {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
            display: block;
        }

        .user-msg .message-timestamp {
            text-align: right;
            margin-right: 4px;
        }

        .bot-msg .message-timestamp {
            text-align: left;
            margin-left: 2px;
        }
    </style>
</head>
<body>

<div class="webchat-container">
    <header class="webchat-header">
        <div class="header-title"><h1>SPAA Assistant</h1></div>
    </header>

    <main class="webchat-messages" id="chat-scroll">
        <div class="message-list" id="message-list">
            <div class="message bot-msg">
                <div class="message-type-icon"><img src="https://marshall-data-bucket-production.s3.amazonaws.com/6a59463e11f143b09/caab9903cb4944a89bd86e417380af6d" class="ai-avatar" width="24" height="24"></div>
                <div class="message-content">
                    <div class="message-bubble">
                        Hello! I'm <b>Friday</b>, the SPAA assistant at Rutgers University-Newark. How can I help you today?
                    </div>
                    <div class="message-timestamp">Just now</div>
                </div>
            </div>
        </div>
    </main>

    <div class="webchat-input">
        <div class="input-wrapper">
            <textarea class="message-input" id="user-input" placeholder="Type message..." rows="1"></textarea>
            <button class="send-button-inline" id="send-btn" disabled>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
            </button>
        </div>
    </div>

    <footer class="webchat-footer">
        Powered by Rutgers SPAA | Privacy & Accessibility
    </footer>
</div>

<script>
    const API_ENDPOINT = 'https://api.drtongc.space/chat';

    // 1. Session Management
    let session_id = localStorage.getItem("spaa_session_id") || crypto.randomUUID();
    localStorage.setItem("spaa_session_id", session_id);
    let conversationContext = ""; 

    // 2. Selectors
    const inputField = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const messageList = document.getElementById('message-list');
    const scrollContainer = document.getElementById('chat-scroll');

    // 3. Enable/Disable Button
    inputField.addEventListener('input', () => {
        sendBtn.disabled = !inputField.value.trim();
    });

    // 4. Send Logic
    sendBtn.addEventListener('click', sendMessage);
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const question = inputField.value.trim();
        if (!question) return;

        // Add user message to UI
        appendMessage(question, 'user');
        inputField.value = '';
        sendBtn.disabled = true;

        // Add placeholder "thinking" message
        const thinkingMsg = appendMessage('Friday is typing...', 'bot');
        thinkingMsg.classList.add('thinking');

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    context: conversationContext,
                    session_id: session_id
                })
            });

            const data = await response.json();
            const answer = data.answer;

            // Update thinking message with actual answer
            thinkingMsg.innerHTML = answer.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            thinkingMsg.classList.remove('thinking');

            conversationContext += `\nUser: ${question}\nAssistant: ${data.raw_text}`;

        } catch (error) {
            thinkingMsg.textContent = "Error: Unable to reach server.";
            thinkingMsg.style.color = "red";
        } finally {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }
    }

    // 5. Unified Message Rendering
    function appendMessage(text, sender) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender === 'user' ? 'user-msg' : 'bot-msg'}`;

        // Get current time in HH:MM AM/PM format
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Add Avatar for Bot only
        let avatarHtml = sender === 'bot' ? 
            `<div class="message-type-icon"><img src="https://marshall-data-bucket-production.s3.amazonaws.com/6a59463e11f143b09/caab9903cb4944a89bd86e417380af6d" class="ai-avatar" width="18" height="18"></div>` : '';

        msgDiv.innerHTML = `
            ${avatarHtml}
            <div class="message-content">
                <div class="message-bubble">${text}</div>
                <div class="message-timestamp">${timeString}</div>
            </div>
        `;

        messageList.appendChild(msgDiv);
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
        
        // Return the bubble element specifically so we can update it later (for thinking state)
        return msgDiv.querySelector('.message-bubble');
    }
</script>

</body>
</html>